{% extends 'layout/base.html' %} {% block content %}

<div class="container-fluid p-0">
  <div class="row">
    <!-- ì¢Œì¸¡: í† í´ë¡œì§€ ë§µ -->
    <div class="col-md-6">
      <div
        id="topology-svg"
        style="
          width: 100%;
          height: 400px;
          border: 1px solid black;
          background-color: #212529;
          border-radius: 3%;
        "
      ></div>
    </div>

    <!-- ìš°ì¸¡: êµ­ì‚¬ì •ë³´, ì¥ë¹„í˜„í™©, ê²½ë³´ ëª©ë¡ -->
    <div class="col-md-6">
      <!-- ìš°ì¸¡ ì „ì²´ ë†’ì´ ê³ ì • -->
      <div style="height: 400px">
        <!-- êµ­ì‚¬ ì •ë³´ -->
        <div class="card-header">
          <h6 class="card-title mb-0 text-primary">| ğŸšï¸ êµ­ì‚¬ ì •ë³´</h6>
        </div>

        <div class="card bg-dark text-white mb-3">
          <div class="card-body">
            <p class="card-text">
              [ êµ­ì‚¬ëª… ] <span id="kuksa-name">-</span> [ êµ­ì‚¬ìœ í˜• ] <span id="kuksa-type">-</span>
            </p>
            <p class="card-text">[ ìš´ìš©ë¶€ì„œ ] <span id="operation-depart">-</span></p>
          </div>
        </div>

        <!-- ì¥ë¹„ í˜„í™© -->
        <div class="card-header">
          <h6 class="card-title mb-0 text-primary">| ğŸ› ï¸ ì¥ë¹„ í˜„í™©</h6>
        </div>

        <div class="card bg-dark text-white mb-3">
          <div class="card-body p-0">
            <!-- í…Œì´ë¸” ìŠ¤í¬ë¡¤ ì¶”ê°€ -->
            <div class="table-responsive" style="max-height: 120px; overflow-y: auto">
              <table class="table table-dark table-hover table-sm mb-0">
                <thead>
                  <tr>
                    <th>ë¶„ì•¼</th>
                    <th>ì¥ë¹„ìœ í˜•</th>
                    <th>ì¥ë¹„ëª¨ë¸</th>
                    <th>ì¥ë¹„ëª…</th>
                  </tr>
                </thead>
                <tbody id="equipment-list"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ìµœê·¼ ê²½ë³´ ëª©ë¡ -->
        <!-- <div class="card-header">
          <h6 class="card-title mb-0 text-primary">| ìµœê·¼ ê²½ë³´í˜„í™©</h6>
        </div> -->

        <div class="card bg-dark text-white">
          <div class="card-body p-0">
            <!-- í…Œì´ë¸” ìŠ¤í¬ë¡¤ ì¶”ê°€ -->
            <div class="table-responsive" style="max-height: 120px; overflow-y: auto">
              <table class="table table-dark table-hover table-sm mb-0">
                <thead>
                  <tr>
                    <th>ì¥ë¹„ëª…</th>
                    <th>ê²½ë³´ëª…</th>
                    <th>ë“±ê¸‰</th>
                    <th>ë°œìƒì¼ì‹œ</th>
                    <th>íšŒë³µì¼ì‹œ</th>
                  </tr>
                </thead>
                <tbody id="alarm-list"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- ìš°ì¸¡ ì „ì²´ ë†’ì´ ê³ ì • ë -->
    </div>
    <!-- col-md-6 ë -->
  </div>
  <!-- row ë -->

  <!-- ì¥ì• ì  ì°¾ê¸° ë²„íŠ¼ -->
  <!-- <form method="POST" class="mt-3">
    <button class="btn btn-danger" style="width: 200px;"><   ì¥ì• ì  ì°¾ê¸°   ></button>
  </form> -->

  <!-- ë„¤íŠ¸ì›Œí¬ ë§µ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
  <div class="mt-3">
    <button id="testNetworkMapBtn" class="btn btn-primary" style="width: 200px">
      ë„¤íŠ¸ì›Œí¬ ë§µ í…ŒìŠ¤íŠ¸
    </button>
  </div>

  <!-- ì¥ì• ì  ê²°ê³¼ -->
  <!-- <div class="mt-3">
    <textarea class="form-control shadow-sm" rows="3" readonly>{{ result or '--- AI ë¶„ì„ ê²°ê³¼ ---' }}</textarea>
  </div> -->

  <!-- ì „ì²´ ê²½ë³´í˜„í™© -->
  <div class="mt-4">
    <!-- <h5 class="mt-4">| ê²½ë³´í˜„í™© |</h5> -->

    <div class="mt-4">
      <h6 class="card-title mb-0 text-primary">| ğŸ”” ìµœê·¼ ê²½ë³´ë°œìƒ í˜„í™©</h6>
    </div>

    <!-- í…Œì´ë¸” ìŠ¤í¬ë¡¤ ì¶”ê°€ -->
    <div class="table-responsive" style="max-height: 40vh; overflow-y: auto">
      <table class="table table-striped table-dark">
        <thead>
          <tr>
            <th>êµ­ì‚¬ëª…</th>
            <th>ë¶„ì•¼</th>
            <th>ë“±ê¸‰</th>
            <th>ìœ íš¨/ë¬´íš¨</th>
            <th>ì¥ë¹„ëª…</th>
            <th>ë°œìƒì¼ì‹œ</th>
            <th>ì•ŒëŒ ë©”ì‹œì§€</th>
            <th>ì¥ì•  ì‚¬ìœ </th>
          </tr>
        </thead>
        <tbody id="alarm_table">
          {% for alarm in alarms %}
          <tr>
            <td>{{ alarm.guksa }}</td>
            <td>{{ alarm.sector }}</td>
            <td>{{ alarm.alarm_grade }}</td>
            <td>{{ alarm.valid_yun }}</td>
            <td>{{ alarm.equip_name }}</td>
            <td>{{ alarm.occur_datetime }}</td>
            <td>{{ alarm.alarm_message }}</td>
            <td>{{ alarm.fault_reason }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" /> -->
<link type="text/css" href="/static/css/vis-network.min.css" rel="stylesheet" />

<!-- <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script> -->
<script src="/static/js/vis-network.min.js"></script>
<script src="/static/js/topology_map.js"></script>

<!-- ì‚¬ì´ë“œë°” í´ë¦­ ì´ë²¤íŠ¸ -->
<script>
  // êµ­ì‚¬ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ - ìˆ˜ì •ëœ ë¶€ë¶„
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.list-group-item').forEach((item) => {
      item.addEventListener('click', async function (e) {
        e.preventDefault();
        const guksaName = this.dataset.name;
        const guksaId = this.dataset.id;

        // ì„ íƒëœ í•­ëª© ê°•ì¡°
        document.querySelectorAll('.list-group-item').forEach((el) => {
          el.classList.remove('active');
        });
        this.classList.add('active');

        try {
          console.log(`êµ­ì‚¬ ì„ íƒ: ${guksaName}, ID: ${guksaId}`);

          // í† í´ë¡œì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const response = await fetch(`/api/topology/${guksaName}`);
          if (!response.ok) {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
          }

          const data = await response.json();
          // print(data)
          console.log('í† í´ë¡œì§€ ë°ì´í„°:', data);

          // í† í´ë¡œì§€ ê·¸ë¦¬ê¸°
          drawTopology(data);

          // êµ­ì‚¬ ì •ë³´ ì—…ë°ì´íŠ¸
          if (data.guksa_info) {
            // updateGuksaInfo(data.guksa_info);

            // ì¥ë¹„ í˜„í™© ì—…ë°ì´íŠ¸
            if (data.equipments) {
              // updateEquipmentList(data.equipments);
            }

            // ê²½ë³´ ëª©ë¡ ì—…ë°ì´íŠ¸
            if (data.alarms) {
              // updateAlarmList(data.alarms);
            }
          } else {
            console.error('êµ­ì‚¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
          alert(`ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
      });
    });
  });

  // êµ­ì‚¬ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateKuksaInfo(info) {
    document.getElementById('kuksa-name').textContent = info.kuksa_name;
    document.getElementById('kuksa-type').textContent = info.kuksa_type;
    document.getElementById('operation-depart').textContent = info.operation_depart;
  }

  // ì¥ë¹„ í˜„í™© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateEquipmentList(equipments) {
    const tbody = document.getElementById('equipment-list');
    tbody.innerHTML = '';

    equipments.forEach((equip) => {
      const row = document.createElement('tr');
      row.innerHTML = `
            <td>${equip.equip_field}</td>
            <td>${equip.equip_type}</td>
            <td>${equip.equip_model}</td>
            <td>${equip.equip_name}</td>
        `;
      tbody.appendChild(row);
    });
  }

  // ê²½ë³´ ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  // function updateAlarmList(alarms) {
  //     const tbody = document.getElementById('alarm-list');
  //     tbody.innerHTML = '';

  //     // ê²½ë³´ë°œìƒì¼ì‹œ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  //     alarms.sort((a, b) => new Date(b.alarm_datetime) - new Date(a.alarm_datetime));

  //     alarms.forEach(alarm => {
  //         const row = document.createElement('tr');
  //         row.innerHTML = `
  //             <td>${alarm.equip.equip_name}</td>
  //             <td>${alarm.alarm_message}</td>
  //             <td>${alarm.alarm_grade}</td>
  //             <td>${alarm.alarm_date}</td>
  //             <td>${alarm.recover_date || '-'}</td>
  //         `;
  //         tbody.appendChild(row);
  //     });
  // }

  // ê²½ë³´ë°œìƒ í˜„í™© ì—…ë°ì´íŠ¸
  document.addEventListener('DOMContentLoaded', function () {
    const kuksaItems = document.querySelectorAll('#kuksa-list .list-group-item');

    kuksaItems.forEach((item) => {
      item.addEventListener('click', async () => {
        const kuksaName = item.dataset.name;
        const response = await fetch(`/api/alarms/${kuksaName}`);
        const alarms = await response.json();
        const tbody = document.getElementById('alarm_table');

        tbody.innerHTML = '';
        // CONSOLE.LOG(tbody)
        alarms.alarms.forEach((item) => {
          const alarm = item.alarms; // alarms ê°ì²´ ê°€ì ¸ì˜¤ê¸°
          const row = `<tr>
                    <td>${item.guksa}</td>
                    <td>${alarm.sector}</td>
                    <td>${alarm.alarm_grade}</td>
                    <td>${alarm.valid_yn}</td>
                    <td>${alarm.equip_name}</td>
                    <td>${alarm.occur_datetime}</td>
                    <td>${alarm.alarm_message}</td>
                    <td>${alarm.fault_reason}</td>
                  </tr>`;

          tbody.innerHTML += row; // tbodyì— í–‰ ì¶”ê°€
        });

        // document.getElementById("alarm-table-container").style.display = "block";
        console.log(alarms.alarms.length);
        if (alarms.alarms.length == 0) {
          document.getElementById('selected_guksa').textContent = '';
        } else {
          document.getElementById('selected_guksa').textContent = alarms.alarms[0].guksa_id;
        }
      });
    });
  });

  // ë„¤íŠ¸ì›Œí¬ ë§µ í…ŒìŠ¤íŠ¸
  document.addEventListener('DOMContentLoaded', function () {
    const testBtn = document.getElementById('testNetworkMapBtn');
    if (testBtn) {
      testBtn.addEventListener('click', async function () {
        try {
          console.log('ë„¤íŠ¸ì›Œí¬ ë§µ ë°ì´í„° ìš”ì²­ ì¤‘...');
          const response = await fetch('/api/network_map');

          if (!response.ok) {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
          }

          const data = await response.json();
          console.log('ë„¤íŠ¸ì›Œí¬ ë§µ ë°ì´í„°:', data);
          alert('ë„¤íŠ¸ì›Œí¬ ë§µ ë°ì´í„°ë¥¼ ì½˜ì†”ì—ì„œ í™•ì¸í•˜ì„¸ìš”');
        } catch (error) {
          console.error('ë„¤íŠ¸ì›Œí¬ ë§µ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
          alert(`ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
      });
    }
  });
</script>

{% endblock %}
